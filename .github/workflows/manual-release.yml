name: Manual Release

on:
  workflow_dispatch:
    inputs:
      release_notes:
        description: 'Release notes (optional)'
        required: false
        default: ''

jobs:
  build-and-release:
    runs-on: windows-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: '9.0.x'

    - name: Get version from Directory.Build.props
      id: get_version
      run: |
        $xml = [xml](Get-Content Directory.Build.props)
        $version = $xml.Project.PropertyGroup.Version
        echo "VERSION=$version" >> $env:GITHUB_OUTPUT
        echo "Version: $version"
      shell: pwsh

    - name: Determine release version
      id: check_release
      run: |
        $baseVersion = "${{ steps.get_version.outputs.VERSION }}"

        # Get all releases and find the latest revision for this version
        $releases = gh release list --limit 100 --json tagName --jq '.[].tagName'
        $latestRevision = 0
        $baseVersionExists = $false

        foreach ($release in $releases) {
          # Check if base version exists
          if ($release -eq $baseVersion -or $release -eq "v$baseVersion") {
            $baseVersionExists = $true
          }
          # Check for revision releases
          if ($release -match "^v?$([regex]::Escape($baseVersion))-rev\.(\d+)$") {
            $revision = [int]$matches[1]
            if ($revision -gt $latestRevision) {
              $latestRevision = $revision
            }
          }
        }

        # Always create a new revision release if base version exists
        if ($baseVersionExists -or $latestRevision -gt 0) {
          $newRevision = $latestRevision + 1
          $releaseVersion = "${baseVersion}-rev.${newRevision}"
          echo "Creating new revision release: $releaseVersion"
        } else {
          # Base version doesn't exist, create it
          $releaseVersion = $baseVersion
          echo "Creating initial release: $releaseVersion"
        }

        echo "RELEASE_VERSION=$releaseVersion" >> $env:GITHUB_OUTPUT
        echo "Final release version: $releaseVersion"
      shell: pwsh
      env:
        GH_TOKEN: ${{ github.token }}

    - name: Restore dependencies
      run: dotnet restore PKHeX.sln

    - name: Publish project
      run: dotnet publish PKHeX.WinForms/PKHeX.WinForms.csproj --configuration Release --runtime win-x64 --self-contained false -p:PublishSingleFile=true -p:PublishReadyToRun=true -p:IncludeAllContentForSelfExtract=true --output publish

    - name: Create release
      run: |
        $version = "${{ steps.check_release.outputs.RELEASE_VERSION }}"
        $baseVersion = "${{ steps.get_version.outputs.VERSION }}"
        $customNotes = "${{ github.event.inputs.release_notes }}"

        # Prepare release notes
        if ($customNotes) {
          $notes = $customNotes
        } elseif ($version -like "*-rev.*") {
          $notes = "## Revision Release v$version`n`n"
          $notes += "- PKHeX.exe has been updated`n"
          $notes += "- PKHeX.Core.dll has been updated`n`n"
          $notes += "*Manual revision release.*"
        } else {
          $notes = "## Release v$version`n`n"
          $notes += "- PKHeX.exe has been updated`n"
          $notes += "- PKHeX.Core.dll has been updated`n`n"
          $notes += "*Manual release build.*"
        }

        $exePath = "publish/PKHeX.exe"
        $corePath = "PKHeX.Core/bin/Release/net9.0/PKHeX.Core.dll"

        # Determine release title
        if ($version -like "*-rev.*") {
          $title = "v$version - Manual Update"
        } else {
          $title = "v$version"
        }

        echo "Creating new release $version"

        # Create release
        gh release create $version --title "$title" --notes "$notes"

        # Upload assets
        if (Test-Path $exePath) {
          gh release upload $version $exePath
        } else {
          echo "Warning: PKHeX.exe not found at $exePath"
        }
        if (Test-Path $corePath) {
          gh release upload $version $corePath
        } else {
          echo "Warning: PKHeX.Core.dll not found at $corePath"
        }
      shell: pwsh
      env:
        GH_TOKEN: ${{ github.token }}
